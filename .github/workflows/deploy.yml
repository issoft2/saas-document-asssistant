name: Deploy to DigitalOcean Droplet

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            echo "ðŸš€ FULL-STACK Deploy as $(whoami) at $(date)"
            
            # Create directories for both backend + frontend
            mkdir -p /srv/company-assistant/{backend,frontend}
            
            # Copy BACKEND .env
            echo "$BACKEND_ENV" > /srv/company-assistant/backend/.env
            chmod 600 /srv/company-assistant/backend/.env
            
            cd /srv/company-assistant
            
            # âœ… COPY FRONTEND STATIC FILES FROM GITHUB RUNNER (SAME REPO!)
            echo "ðŸ“¦ Copying frontend static files from repo..."
            cp -r $GITHUB_WORKSPACE/frontend/dist/* frontend/ || echo "âš ï¸ No dist/ found locally"
            cp $GITHUB_WORKSPACE/frontend/nginx.conf frontend/nginx.conf || echo "âš ï¸ No nginx.conf"
            
            # Pull backend image
            docker pull specisaac/company-assistant-backend:latest
            
            # CREATE PRODUCTION docker-compose-production.yml
            cat > docker-compose-production.yml<< 'EOF'
            version: "3.9"
            services:
              backend:
                image: specisaac/company-assistant-backend:latest
                ports:
                  - "8000:8000"
                env_file:
                  - ./backend/.env
                volumes:
                  - chroma_data:/app/chromadb_multi_tenant
                  - ./data:/app/data
                restart: unless-stopped
                networks: [app_net]
              
              nginx:
                image: nginx:alpine
                container_name: frontend-nginx
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - /etc/letsencrypt/live/lexiscope.duckdns.org:/etc/letsencrypt/live/lexiscope.duckdns.org:ro
                  - /etc/letsencrypt/archive/lexiscope.duckdns.org:/etc/letsencrypt/archive/lexiscope.duckdns.org:ro
                  - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
                  - ./frontend:/usr/share/nginx/html:ro
                restart: unless-stopped
                depends_on: [backend]
                networks: [app_net]
            
            volumes: { chroma_data: {} }
            networks: { app_net: { driver: bridge } }
            EOF
            
            # Deploy full stack
            docker compose up -d --remove-orphans
            
            # Health check
            sleep 15
            if ! docker compose ps | grep -E "(nginx|backend).*Up"; then
              echo "âŒ Services failed:"
              docker compose logs --tail=20
              exit 1
            fi
            
            echo "ðŸŽ‰ FULL-STACK LIVE!"
            echo "ðŸŒ https://${HOSTNAME}"
            docker compose ps
