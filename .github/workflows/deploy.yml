name: Deploy to DigitalOcean Droplet

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            echo "ðŸš€ Deploying as $(whoami) at $(date)"
            
            # Create app directory structure
            mkdir -p /srv/company-assistant/backend
            
            # Write production .env file
            echo "$BACKEND_ENV" > /srv/company-assistant/backend/.env
            chmod 600 /srv/company-assistant/backend/.env
            echo "âœ… Environment configured"
            
            cd /srv/company-assistant || { echo "âŒ Project dir missing"; exit 1; }
            
            # Pull latest image FIRST
            docker pull specisaac/company-assistant-backend:latest
            echo "âœ… Latest image pulled"
            
            # CREATE & USE docker-compose-production.yml WITH -f FLAG
            cat > docker-compose.yml << 'EOF'
            services:
              backend:
                image: specisaac/company-assistant-backend:latest
                ports:
                  - "8000:8000"
                env_file:
                  - ./backend/.env
                restart: unless-stopped
            EOF
            
            echo "âœ… docker-compose.yml created"
            
            # Zero-downtime deployment (uses default docker-compose.yml)
            docker compose up -d --remove-orphans
            echo "âœ… Services deployed"
            
            # Health check
            sleep 15
            if ! docker compose ps | grep "Up"; then
              echo "âŒ Services failed to start:"
              docker compose logs --tail=20
              exit 1
            fi
            
            echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
            echo "ðŸŒ Live at: http://${HOSTNAME}:8000"
            docker compose ps
