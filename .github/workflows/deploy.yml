name: Deploy Full-Stack to DigitalOcean
on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # âœ… NEW: Build frontend ON GITHUB RUNNER
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Your existing script with FIXED nginx volume mount
            set -e
            echo "ðŸš€ FULL-STACK Deploy as $(whoami)"
            
            mkdir -p /srv/company-assistant/{backend,frontend}
            echo "$BACKEND_ENV" > /srv/company-assistant/backend/.env
            chmod 600 /srv/company-assistant/backend/.env
            
            cd /srv/company-assistant
            
            # Copy BUILT frontend files from GitHub runner
            cp -r $GITHUB_WORKSPACE/frontend/dist/* frontend/
            cp $GITHUB_WORKSPACE/frontend/nginx.conf frontend/nginx.conf || echo "âš ï¸ No nginx.conf"
            
            docker pull specisaac/company-assistant-backend:latest
            
            # FIXED docker-compose-production.yml
            cat > docker-compose-production.yml << 'EOF'
            version: "3.9"
            services:
              backend:
                image: specisaac/company-assistant-backend:latest
                ports: ["8000:8000"]
                env_file: ['./backend/.env']
                volumes:
                  - chroma_data:/app/chromadb_multi_tenant
                  - ./data:/app/data
                restart: unless-stopped
                networks: [app_net]
              
              nginx:
                image: nginx:alpine
                container_name: frontend-nginx
                ports: ["80:80", "443:443"]
                volumes:
                  - /etc/letsencrypt/live/lexiscope.duckdns.org:/etc/letsencrypt/live/lexiscope.duckdns.org:ro
                  - /etc/letsencrypt/archive/lexiscope.duckdns.org:/etc/letsencrypt/archive/lexiscope.duckdns.org:ro
                  - ./frontend:/usr/share/nginx/html:ro  # âœ… FIXED
                restart: unless-stopped
                depends_on: [backend]
                networks: [app_net]
            
            volumes: { chroma_data: {} }
            networks: { app_net: { driver: bridge } }
            EOF
            
            docker compose -f docker-compose-production.yml up -d --remove-orphans
            sleep 15
            docker compose -f docker-compose-production.yml ps
