name: Deploy to DigitalOcean Droplet

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  # Add packages:read for GHCR
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        envs:
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            
            # Ensure directories
            mkdir -p /srv/company-assistant/backend
            
            # Fix Docker Compose .env lookup issue
            touch /srv/company-assistant/.env
            
            # Write backend .env from secret
            echo "$BACKEND_ENV" > /srv/company-assistant/backend/.env
            
            cd /srv/company-assistant || { echo "Project dir missing"; exit 1; }
            
            # NON-INTERACTIVE GHCR login (this fixes your error)
            echo "$GHCR_PAT" | docker login ghcr.io --username issoft2 --password-stdin
            
            # Pull backend image
            docker pull ghcr.io/issoft2/company-assistant-backend:latest
            
            # Deploy (docker-compose.yml should use env_file: ./backend/.env)
            docker compose -f docker-compose-production.yml up -d --remove-orphans
            
            # Health check
            sleep 10
            if ! docker compose -f docker-compose-production.yml ps | grep Up; then
              echo "Services failed to start"
              docker compose -f docker-compose-production.yml logs
              exit 1
            fi
            
            
