name: Deploy to DigitalOcean Droplet

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            echo "üöÄ Deploying as $(whoami) at $(date)"
            
            # Create directories
            mkdir -p /srv/company-assistant/backend
            
            # Write production .env
            echo "$BACKEND_ENV" > /srv/company-assistant/backend/.env
            chmod 600 /srv/company-assistant/backend/.env
            
            cd /srv/company-assistant || { echo "‚ùå Project dir missing"; exit 1; }
            
            # Docker Hub pull (your working build action)
            docker pull issoft2/company-assistant-backend:latest
            
            # Ensure compose file exists
            if [ ! -f docker-compose-production.yml ]; then
              echo "‚ùå docker-compose-production.yml missing"
              exit 1
            fi
            
            # Zero-downtime deploy
            docker compose -f docker-compose-production.yml pull
            docker compose -f docker-compose-production.yml up -d --remove-orphans
            
            # Health check
            sleep 10
            if ! docker compose -f docker-compose-production.yml ps | grep "Up"; then
              echo "‚ùå Services failed:"
              docker compose -f docker-compose-production.yml logs --tail=50
              exit 1
            fi
            
            echo "üéâ DEPLOYMENT SUCCESSFUL!"
            echo "üåê Live at: http://${HOSTNAME}:8000"
            docker compose -f docker-compose-production.yml ps
