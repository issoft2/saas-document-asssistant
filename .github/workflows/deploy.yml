- name: Deploy frontend via rsync
  uses: burnett01/rsync-deployments@v6
  with:
    switches: -az --delete
    path: frontend/dist/
    remote_path: /srv/company-assistant/frontend/
    remote_host: ${{ secrets.SSH_HOST }}
    remote_user: ${{ secrets.SSH_USER }}
    remote_key: ${{ secrets.SSH_KEY }}
    remote_port: ${{ secrets.SSH_PORT || 22 }}

- name: Deploy backend over SSH
  uses: appleboy/ssh-action@v1.0.3
  env:
    BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
  with:
    host: ${{ secrets.SSH_HOST }}
    username: ${{ secrets.SSH_USER }}
    key: ${{ secrets.SSH_KEY }}
    port: ${{ secrets.SSH_PORT || 22 }}
    script: |
      set -e
      cd /srv/company-assistant

      # Ensure directories
      mkdir -p backend data

      # Write .env (overwrite to avoid duplicates)
      echo "$BACKEND_ENV" > backend/.env
      chmod 600 backend/.env

      # Pull latest image & start backend
      docker compose -f docker-compose-production.yml pull
      docker compose -f docker-compose-production.yml up -d --remove-orphans

      echo "Waiting 15s for backend startup..."
      sleep 15

      # Simple health check
      if ! docker compose -f docker-compose-production.yml ps | grep -E "backend.*Up"; then
        echo "❌ Backend not running! Check logs:"
        docker compose -f docker-compose-production.yml logs --tail=50
        exit 1
      else
        echo "✅ Backend container is UP!"
        docker compose -f docker-compose-production.yml ps
      fi
